# !!! All drafts were generated by Windows Copilot and have not been tested yet !!!

# **What you must do BEFORE running `docker compose up -d`**

## 1) **Create the directory structure**
Your project folder should contain:

```
./openvpn-data/
./stunnel/stunnel.conf
./certs/        # empty — LE will place certificates here
./vhost/
./html/
docker-compose.yml
```

---

## 2) **Generate the OpenVPN server configuration**
This is mandatory — the container does NOT generate PKI automatically.

```bash
docker run -v $PWD/openvpn-data:/etc/openvpn --rm kylemanna/openvpn ovpn_genconfig -u tcp://127.0.0.1
```

---

## 3) **Initialize the PKI**
Also mandatory:

```bash
docker run -v $PWD/openvpn-data:/etc/openvpn --rm -it kylemanna/openvpn ovpn_initpki
```

You will set the CA password and confirm certificate generation.

---

## 4) **Verify DNS**
For Let’s Encrypt to work:

- The domain `vpn.example.com` must point to your server’s IP  
- Port **80** must be open  
- nginx‑proxy must be able to receive the ACME challenge  

If DNS is not configured — certificates will not be issued.

---

# **Now you can run the stack**

```bash
docker compose up -d
```

---

# **What you must do AFTER launching**

## 1) **Check that nginx-proxy obtained certificates**

After 10–30 seconds:

```bash
docker logs letsencrypt
```

You should see:

```
Creating/renewal vpn.example.com certificates... done.
```

And the `./certs/` directory should contain:

```
vpn.example.com.crt
vpn.example.com.key
vpn.example.com.chain.pem
```

---

## 2) **Check that stunnel started successfully**

```bash
docker logs stunnel
```

Expected output:

```
Configuration successful
Service openvpn started
```

---

## 3) **Create a client certificate**

```bash
docker run -v $PWD/openvpn-data:/etc/openvpn --rm -it kylemanna/openvpn easyrsa build-client-full client1 nopass
```

---

## 4) **Generate the client .ovpn file**

```bash
docker run -v $PWD/openvpn-data:/etc/openvpn --rm kylemanna/openvpn ovpn_getclient client1 > client1.ovpn
```

You will use this file together with the stunnel client.

---

# **Summary: what is automatic and what is manual**

| Task | Automatic | Manual |
|------|-----------|--------|
| Starting containers | ✔ | |
| Generating OpenVPN PKI | | ✔ (one time) |
| Creating client certificates | | ✔ |
| Let’s Encrypt certificate issuance | ✔ | |
| Let’s Encrypt auto-renewal | ✔ | |
| HTTPS → stunnel proxying | ✔ | |
| OpenVPN obfuscation | ✔ | |
| DNS setup | | ✔ |

